#!/bin/bash

# Point ~/.ssh/agent/${HOSTNAME}/sock at the current value of SSH_AUTH_SOCK.
#
# Use as 'ssh -A machine forward-ssh-agent'.

MAX_FORWARD_SESSIONS="100"

PROG="$(basename -- "${0}")"

if [ -z "${SSH_AUTH_SOCK}" ]; then
    echo "${PROG}: No ssh agent found." 1>&2
    exit 1
fi

MY_SSH_AUTH_DIR="${HOME}/.ssh/agent/${HOSTNAME}"

# The filesystem location of the active auth socket
MY_SSH_AUTH_SOCK="${MY_SSH_AUTH_DIR}/sock"

SAVED_SSH_AUTH_SOCK="${MY_SSH_AUTH_DIR}/sock.saved"
for (( n = 0; n < MAX_FORWARD_SESSIONS; n++ )); do
    if [ -f "${SAVED_SSH_AUTH_SOCK}" ]; then
        SAVED_SSH_AUTH_SOCK="${SAVED_SSH_AUTH_SOCK%.[0-9]*}.${n}"
    fi
done

# The auth socket inherited from the environment
FORWARDED_SSH_AUTH_SOCK="${SSH_AUTH_SOCK}"

trap "mv '${SAVED_SSH_AUTH_SOCK}' '${MY_SSH_AUTH_SOCK}'" EXIT

mv "${MY_SSH_AUTH_SOCK}" "${SAVED_SSH_AUTH_SOCK}"
ln -s "${FORWARDED_SSH_AUTH_SOCK}" "${MY_SSH_AUTH_SOCK}"

echo 'Press enter to terminate.'
read x
