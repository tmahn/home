#!/bin/bash

# Install rdiff backup (and librsync prerequisite)

set -eu

SCRATCH_DIR="${HOME}/scratch"
PREFIX="${HOME}/usr"
RDIFF_BACKUP_VERSION="1.0.5"
LIBRSYNC_VERSION="0.9.7"
PYTHON_MINOR_VERSION="2.4"
PYTHON_PACKAGE_DIR="${PREFIX}/lib/python${PYTHON_MINOR_VERSION}/site-packages"

mkdir -p -- "${SCRATCH_DIR}"
cd -- "${SCRATCH_DIR}"

LIBRSYNC_ARCHIVE="librsync-${LIBRSYNC_VERSION}.tar.gz"
wget "http://downloads.sourceforge.net/librsync/${LIBRSYNC_ARCHIVE}"
tar zxf "${LIBRSYNC_ARCHIVE}"
cd "${LIBRSYNC_ARCHIVE%.tar.gz}"
./configure --prefix="${PREFIX}"
make install
cd ..

RDIFF_BACKUP_ARCHIVE="rdiff-backup-${RDIFF_BACKUP_VERSION}.tar.gz"
curl -L > "${RDIFF_BACKUP_ARCHIVE}" \
    "http://savannah.nongnu.org/download/rdiff-backup/${RDIFF_BACKUP_ARCHIVE}"
tar zxf "${RDIFF_BACKUP_ARCHIVE}"
cd "${RDIFF_BACKUP_ARCHIVE%.tar.gz}"
env LIBRSYNC_DIR="${PREFIX}" python setup.py install --prefix="${PREFIX}"

sed -i "${PREFIX}/bin/rdiff-backup" \
    -e "/^import sys\$/asys.path.append('${PYTHON_PACKAGE_DIR}')"

"${PREFIX}/bin/rdiff-backup" --version
