#!/usr/bin/env python
# coding: UTF-8

"""
Copy the files from an iPhone backup directory (ca. iTunes 9) to their
original directory structure.

E.g., 3d0d7e5fb2ce288813306e4d4636395e047a3d28.mddata becomes
HomeDomain/Library/SMS/sms.db.
"""

from __future__ import with_statement

USAGE ="%prog SOURCE DESTINATION"

# I have no idea what “3d0d7e5fb2ce288813306e4d4636395e047a3d28” means.

import glob
import sys
from libplist.PList import PListNode
from optparse import OptionParser
from path import path

def extract_backup(src='.', dst='.'):
    src = path(src)
    dst = path(dst)

    for file in src.glob('*.mdinfo'):
        with open(file) as file_contents:
            mdinfo = PListNode(file_contents.read())
        md = PListNode(mdinfo.get_dict_el_from_key('Metadata').as_data())

        md_domain = md.get_dict_el_from_key('Domain').as_string()
        md_path = md.get_dict_el_from_key('Path').as_string()

        in_path = path(file)
        in_path = in_path.parent.joinpath(in_path.namebase) + '.mddata'
        out_path = dst.joinpath(md_domain).joinpath(md_path)

        if not out_path.parent.isdir():
            out_path.parent.makedirs()
        in_path.copy2(out_path)

def main(args=None):
    if args is None:
        args = sys.argv[1:]

    optp = OptionParser(usage=USAGE, description=__doc__.strip())
    (options, args) = optp.parse_args(args)
    extract_backup(*args)

if __name__ == '__main__':
    sys.exit(main())
