#!/usr/bin/env python

"""
Compare two xml files. diff-options are passed on to diff.

Files are run through 'xmllint --format' first to remove presentational
differences.
"""
USAGE = "%prog [options] [diff-options] FILE1 FILE2"

import os
import subprocess
import sys
import optparse
from optparse import OptionParser

class FileDescriptorName(str):
    """
    The file name of a file descriptor.

    When you open a pipe with Popen, as far as I can tell, the file
    descriptor will be closed if the pipe object goes out of scope. So this
    extends str to attach a reference to the pipe as an attribute, so that
    it will still be open when it is time to use it.
    """

    def __new__(cls, process, fileno):
        obj = str.__new__(FileDescriptorName, "/dev/fd/%d" % fileno)
        obj.process = process
        return obj

def process_substitute(cmd):
    """Execute cmd, returning the name of a file containing its stdout.
    Like <(cmd) in bash."""

    cmd = subprocess.Popen(cmd, stdout=subprocess.PIPE)
    return FileDescriptorName(cmd, cmd.stdout.fileno())

class NonStrictOptionParser(OptionParser):
    """
    An option parser that is liberal about unknown options. Stop processing
    arguments at the first unknown option.
    """

    def _process_args(self, largs, rargs, values):
        try:
            return OptionParser._process_args(self, largs, rargs, values)
        except optparse.BadOptionError, ex:
            rargs.insert(0, ex.opt_str)
            return

def main(args=None):
    if not args:
        args = sys.argv[1:]

    ##
    parser = NonStrictOptionParser(description=__doc__.strip(), usage=USAGE)
    default_diff_cmd = 'diff'
    parser.add_option("--diff-cmd", action="store", dest="diff_cmd",
            default=default_diff_cmd,
            help="Use this command to compare the formatted files.")
    (options, args) = parser.parse_args(args=args)

    diff_opts = args[:-2]
    files = args[-2:]
    if len(files) != 2:
        parser.print_help()
        return 1

    if options.diff_cmd == default_diff_cmd and not diff_opts:
        diff_opts = ['-u']

    os.execvp(options.diff_cmd, [options.diff_cmd] + diff_opts
        + [process_substitute(['xmllint', '--format', f]) for f in files])

if __name__ == '__main__':
    sys.exit(main())
