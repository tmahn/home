#!/usr/bin/env python

"""
Compare two xml files. diff-options are passed on to diff.

Files are run through 'xmllint --format' first to remove presentational
differences.
"""
USAGE = "%prog [options] [diff-options] FILE1 FILE2"

import os
import subprocess
import sys

from blindrut.os import process_substitute, unix_pipe
from blindrut.optparse import NonStrictOptionParser

def main(args=None):
    if not args:
        args = sys.argv[1:]

    ##
    parser = NonStrictOptionParser(description=__doc__.strip(), usage=USAGE)
    default_diff_cmd = 'diff'
    parser.add_option("--diff-cmd", action="store", dest="diff_cmd",
            default=default_diff_cmd,
            help="Use this command to compare the formatted files.")
    (options, args) = parser.parse_args(args=args)

    diff_opts = args[:-2]
    if len(args) < 2:
        parser.print_help()
        return 1

    if options.diff_cmd == default_diff_cmd and not diff_opts:
        diff_opts = ['-u']

    files = args[-2:]
    files = [process_substitute(['xmllint', '--format', f]) for f in files]
    try:
        subprocess.check_call([options.diff_cmd] + diff_opts + files)
    except subprocess.CalledProcessError, ex:
        return ex.returncode
    ret1, ret2 = [f.process.wait() for f in files]
    if ret1:
        return ret1
    if ret2:
        return ret2

if __name__ == '__main__':
    sys.exit(main())
